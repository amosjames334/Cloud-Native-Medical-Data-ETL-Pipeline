executor: KubernetesExecutor

images:
  airflow:
    repository: medical-etl-airflow
    tag: v1
    pullPolicy: IfNotPresent

# secret-backed variables (templated block the chart will render into env[])
extraEnv: |-
  - name: AWS_ACCESS_KEY_ID
    valueFrom:
      secretKeyRef:
        name: airflow-env-vars
        key: AWS_ACCESS_KEY_ID
  - name: AWS_SECRET_ACCESS_KEY
    valueFrom:
      secretKeyRef:
        name: airflow-env-vars
        key: AWS_SECRET_ACCESS_KEY
  - name: S3_BUCKET
    valueFrom:
      secretKeyRef:
        name: airflow-env-vars
        key: S3_BUCKET
  - name: DOCKER_IMAGE
    valueFrom:
      secretKeyRef:
        name: airflow-env-vars
        key: DOCKER_IMAGE

# Plain string envs (must include `value`)
env:
  - name: AIRFLOW__CORE__LOAD_EXAMPLES
    value: "False"
  - name: AWS_DEFAULT_REGION
    value: "us-east-1"

webserver:
  env:
    - name: AIRFLOW__API__AUTH_BACKENDS
      value: "airflow.api.auth.backend.basic_auth"
    - name: AIRFLOW__WEBSERVER__EXPOSE_CONFIG
      value: "True"
    - name: AIRFLOW__WEBSERVER__ENABLE_PROXY_FIX
      value: "True"
    - name: AIRFLOW__API__ENABLE_EXPERIMENTAL_API
      value: "True"

  service:
    type: LoadBalancer
    ports:
      - name: airflow-ui
        port: 8080

# Ensure workers block contains serviceAccount to avoid nil pointer in template
workers:
  serviceAccount:
    create: true
    name: ""
    annotations: {}

# Provide a scheduler block (keep empty but present if templates reference it)
scheduler:
  serviceAccount:
    create: true
    name: ""
    annotations: {}

triggerer:
  serviceAccount:
    create: true
    name: ""
    annotations: {}

postgresql:
  enabled: false

data:
  metadataConnection:
    user: airflow
    pass: airflow
    protocol: postgresql
    host: host.docker.internal
    port: 5432
    db: airflow

dags:
  persistence:
    enabled: false
  gitSync:
    enabled: true
    repo: https://github.com/amosjames334/Cloud-Native-Medical-Data-ETL-Pipeline.git
    branch: main
    rev: HEAD
    depth: 1
    maxFailures: 0
    subPath: "dags"
    wait: 60
